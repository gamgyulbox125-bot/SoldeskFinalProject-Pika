<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>DM with <th:block th:text="${recipientId}"></th:block></title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <style>
        body {
            padding-top: 230px !important; /* fixed header 보정 */
            background-color: #ffffff;
            margin: 0;
            font-family: 'Pretendard', sans-serif;
        }

        /* dm.html 기존 스타일 */
        .msgArea img, .msgArea video { max-width: 300px; max-height: 300px; border-radius: 8px; margin-top: 5px; }
        .my-message { text-align: right; }
    </style>
</head>
<body>
    <header th:replace="~{header :: mainHeader}"></header>

    <div class="msgArea" style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll;">
        <!-- Messages will be loaded here -->
    </div>
    <br>
    <div>
        <input type="text" placeholder="Send a message" class="content" style="width: 80%;">
        <button type="button" onclick="sendMsg()">Send</button>
    </div>
    <div>
        <input type="file" id="mediaFile" accept="image/*,video/*">
        <button type="button" onclick="sendMedia()">Send Media</button>
    </div>
    <br/>
    <a th:href="@{/chat/userList}">Back to User List</a>

<script th:inline="javascript">
    console.log("dm.html script executed.");
    /*<![CDATA[*/
    const senderId = [[${senderId}]];
    const recipientId = [[${recipientId}]];
    const productId = [[${productId}]]; // Get productId from the model
    const historicalMessages = /*[[${messages}]]*/ [];
    /*]]>*/

    console.log("DM Initialized. Sender:", senderId, "Recipient:", recipientId, "Product ID:", productId);
    console.log("Historical Messages from server (raw):", historicalMessages);

    const msgArea = document.querySelector('.msgArea');
    const contentInput = document.querySelector('.content');
    const mediaFileInput = document.getElementById('mediaFile');

    window.displayMessage = function(msgObj) {
        console.log("[displayMessage] Received object:", msgObj);
        const div = document.createElement('div');
        let messageElement;

        const messageSender = msgObj.sender || msgObj.senderId;
        const messageContent = msgObj.msg || msgObj.content;
        const messageType = msgObj.type;
        console.log(`[displayMessage] Details - Sender: ${messageSender}, Type: ${messageType}, Content: ${messageContent}`);


        if (messageSender === senderId) {
            div.classList.add('my-message');
        }

        if (messageSender === 'system') {
            messageElement = document.createElement('i');
            messageElement.innerText = "[System] " + messageContent;
            messageElement.style.color = 'red';
            div.appendChild(messageElement);
        } else {
            const prefix = document.createElement('strong');
            prefix.innerText = messageSender === senderId ? "Me: " : messageSender + ": ";
            div.appendChild(prefix);

            if (messageType === 'IMAGE') {
                div.appendChild(document.createElement('br'));
                messageElement = document.createElement('img');
                messageElement.src = messageContent;
                div.appendChild(messageElement);
            } else if (messageType === 'VIDEO') {
                div.appendChild(document.createElement('br'));
                messageElement = document.createElement('video');
                messageElement.src = messageContent;
                messageElement.controls = true;
                div.appendChild(messageElement);
            } else { // TALK or undefined type
                const textNode = document.createTextNode(messageContent);
                div.appendChild(textNode);
            }
        }

        console.log("[displayMessage] Appending to msgArea:", div);
        msgArea.append(div);
        msgArea.scrollTop = msgArea.scrollHeight;
    }

    // --- New Event-based Logic ---
    document.addEventListener('DOMContentLoaded', function() {
        // Helper function to guess message type from content
        function getMessageTypeFromContent(content) {
            if (typeof content !== 'string') return 'TALK';
            const lowerCaseContent = content.toLowerCase();
            if (lowerCaseContent.startsWith('/chat-media/')) {
                if (lowerCaseContent.endsWith('.jpg') || lowerCaseContent.endsWith('.jpeg') || lowerCaseContent.endsWith('.png') || lowerCaseContent.endsWith('.gif')) {
                    return 'IMAGE';
                }
                if (lowerCaseContent.endsWith('.mp4') || lowerCaseContent.endsWith('.webm') || lowerCaseContent.endsWith('.ogg')) {
                    return 'VIDEO';
                }
            }
            return 'TALK';
        }

        // 1. Load historical messages
        console.log("DOMContentLoaded: Loading historical messages loop starting...");
        for (const msg of historicalMessages) {
            console.log("[History Loop] Raw msg from server:", msg);
            const adaptedMsg = {
                senderId: msg.senderId,
                recipientId: msg.recipientId,
                content: msg.content,
                type: getMessageTypeFromContent(msg.content) // Infer type from content
            };
            console.log("[History Loop] Adapted msg before display:", adaptedMsg);
            window.displayMessage(adaptedMsg);
        }
        console.log("DOMContentLoaded: Loading historical messages loop finished.");

        // 2. Listen for new messages from the global WebSocket
        document.addEventListener('chat:message', function(event) {
            const msg = event.detail;
            console.log("DM page received 'chat:message' event:", msg);

            // Check if the message belongs to this specific chat room
            console.log(`!![chat:message listener] Debugging sender/recipient comparison:`);
            console.log(`!!  msg.sender: ${msg.sender} (Type: ${typeof msg.sender})`);
            console.log(`!!  page senderId: ${senderId} (Type: ${typeof senderId})`);
            console.log(`!!  msg.recipientId: ${msg.recipientId} (Type: ${typeof msg.recipientId})`);
            console.log(`!!  page recipientId: ${recipientId} (Type: ${typeof recipientId})`);

            const isMyMessage = msg.sender === senderId && msg.recipientId === recipientId;
            const isTheirMessage = msg.sender === recipientId && msg.recipientId === senderId;
            // Ensure productId from event (number) is compared correctly with productId from page (can be string)
            const isSameProduct = msg.productId == productId;

            console.log(`[chat:message listener] isMyMessage: ${isMyMessage}`);
            console.log(`[chat:message listener] isTheirMessage: ${isTheirMessage}`);
            console.log(`[chat:message listener] Comparing Product IDs:`);
            console.log(`  msg.productId: ${msg.productId} (Type: ${typeof msg.productId})`);
            console.log(`  page productId: ${productId} (Type: ${typeof productId})`);
            console.log(`  isSameProduct result (msg.productId == productId): ${isSameProduct}`);

            if ((isMyMessage || isTheirMessage) && isSameProduct) {
                console.log("Message is for this room. Displaying...");
                window.displayMessage(msg);
            } else {
                console.log("Message is for another room. Ignoring display.");
            }
        });
    });


    window.sendMsg = function() {
        const content = contentInput.value;
        if (content.trim() === "") return;

        const dmMsg = {
            "type": "TALK",
            "sender": senderId,
            "recipientId": recipientId,
            "msg": content,
            "productId": productId
        };
        window.sendMessageOverSocket(dmMsg);
        contentInput.value = '';
    }

    window.sendMedia = async function() {
        const file = mediaFileInput.files[0];
        if (!file) {
            alert("Please select a file to send.");
            return;
        }

        const formData = new FormData();
        formData.append("file", file);

        try {
            const response = await fetch("/chat/upload", {
                method: "POST",
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "File upload failed.");
            }

            const result = await response.json();
            const filePath = result.filePath;
            const fileType = file.type.startsWith('image/') ? 'IMAGE' : (file.type.startsWith('video/') ? 'VIDEO' : 'TALK');

            if(fileType === 'TALK'){
                alert("Unsupported file type.");
                return;
            }

            const dmMsg = {
                "type": fileType,
                "sender": senderId,
                "recipientId": recipientId,
                "msg": filePath,
                "productId": productId
            };
            window.sendMessageOverSocket(dmMsg);
            mediaFileInput.value = ''; // Clear file input
        } catch (error) {
            console.error("Error sending media:", error);
            alert("Error sending media: " + error.message);
        }
    }

    window.sendMessageOverSocket = function(msgObj) {
        console.log("[sendMessageOverSocket] Attempting to send message:", msgObj);
        console.log("[sendMessageOverSocket] typeof stompClient:", typeof stompClient);
        if (typeof stompClient !== 'undefined') {
            console.log("[sendMessageOverSocket] stompClient.connected:", stompClient.connected); // Check .connected for STOMP
        }

        // Use the global 'stompClient' variable defined in chat-websocket.js
        if (stompClient && stompClient.connected) { // Check stompClient.connected for STOMP
            console.log("Sending message object via global stompClient:", msgObj);
            // STOMP send method: destination, headers, body
            stompClient.send("/pub/chat.sendMessage", {}, JSON.stringify(msgObj));
            // Don't display self-sent message here anymore,
            // as the server will echo it back and the event listener will catch it.
            // This ensures a single source of truth for message display.
        } else {
            console.error("Global STOMP WebSocket is not connected or not available.");
            if (typeof stompClient === 'undefined' || stompClient === null) {
                alert("Cannot send message. STOMP WebSocket is not initialized. Please refresh the page.");
            } else if (!stompClient.connected) { // STOMP-specific check for not connected
                alert("Cannot send message. STOMP WebSocket is not connected. Please wait a moment or refresh.");
            } else {
                alert("Cannot send message. Connection is not available.");
            }
        }
    }

    contentInput.addEventListener('keyup', (event) => {
        if (event.key === 'Enter') window.sendMsg();
    });

    window.createNoticeDiv = function(text) {
        const noticeDiv = document.createElement('div');
        noticeDiv.innerText = text;
        noticeDiv.style.cssText = 'color: gray; font-style: italic; text-align: center;';
        return noticeDiv;
    }
    </script th:inline="javascript">

</body>
</html>